# PPO for CarRacing-v3 (é«˜æ€§èƒ½ä¼˜åŒ–ç‰ˆ)

åŸºäºStable Baselines3æœ€ä½³å®è·µçš„PPOå®ç°ï¼Œç”¨äºè®­ç»ƒCarRacing-v3èµ›è½¦æ¸¸æˆæ™ºèƒ½ä½“ã€‚

## âœ¨ ç‰¹æ€§

### ğŸš€ æ€§èƒ½ä¼˜åŒ–
- âœ… **å‘é‡åŒ–ç¯å¢ƒ**ï¼š8ä¸ªå¹¶è¡Œç¯å¢ƒï¼Œ6-7å€é‡‡æ ·åŠ é€Ÿ
- âœ… **é¢„åˆ†é…Buffer**ï¼šRolloutBufferä½¿ç”¨NumPyé¢„åˆ†é…æ•°ç»„ï¼Œé›¶æ‹·è´è½¬Tensor
- âœ… **æ··åˆç²¾åº¦è®­ç»ƒ(AMP)**ï¼š1.5-2å€è®­ç»ƒåŠ é€Ÿï¼ŒèŠ‚çœ40%æ˜¾å­˜
- âœ… **cuDNN Benchmark**ï¼šè‡ªåŠ¨é€‰æ‹©æœ€ä¼˜å·ç§¯ç®—æ³•
- âœ… **æ¢¯åº¦è£å‰ª**ï¼šé˜²æ­¢æ¢¯åº¦çˆ†ç‚¸ï¼Œè®­ç»ƒæ›´ç¨³å®š
- âœ… **AdamWä¼˜åŒ–å™¨**ï¼šå¸¦weight decayçš„Adam

### ğŸ¯ ç®—æ³•å®ç°
- âœ… **Clipped Surrogate Objective**ï¼šPPOæ ¸å¿ƒï¼Œé˜²æ­¢ç­–ç•¥æ›´æ–°è¿‡å¤§
- âœ… **GAEä¼˜åŠ¿ä¼°è®¡**ï¼šÎ»=0.95ï¼Œå‡å°‘æ–¹å·®
- âœ… **Mini-batchæ›´æ–°**ï¼šå¤šepochè®­ç»ƒï¼Œæå‡æ ·æœ¬åˆ©ç”¨ç‡
- âœ… **Entropy Bonus**ï¼šé¼“åŠ±æ¢ç´¢
- âœ… **Value Function Clipping**ï¼ˆå¯é€‰ï¼‰

### ğŸ–¼ï¸ ç¯å¢ƒé¢„å¤„ç†
- ç°åº¦åŒ–ï¼šRGB â†’ ç°åº¦ (96Ã—96Ã—3 â†’ 96Ã—96)
- è£å‰ªï¼šå»é™¤åº•éƒ¨çŠ¶æ€æ¡ (96Ã—96 â†’ 84Ã—84)
- å¸§å †å ï¼šå †å 4å¸§ â†’ (4, 84, 84)
- å½’ä¸€åŒ–ï¼šé™¤ä»¥255å½’ä¸€åŒ–åˆ°[0,1]

## ğŸ“¦ ä¾èµ–

```bash
gymnasium>=0.29.0
numpy>=1.24.0
torch>=2.0.0
opencv-python>=4.8.0
rich>=13.0.0
matplotlib>=3.7.0
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### åŸºç¡€è®­ç»ƒ

```bash
cd "C:\Users\28413\Desktop\Car_Racing\DRL-main\CarRacing\é‡æ„\PPO"
python main.py
```

### è‡ªå®šä¹‰å‚æ•°

```bash
python main.py \
    --total_timesteps 2000000 \
    --num_envs 8 \
    --n_steps 2048 \
    --batch_size 64 \
    --lr 3e-4 \
    --n_epochs 10
```

### ä¸»è¦å‚æ•°è¯´æ˜

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--total_timesteps` | 2,000,000 | æ€»è®­ç»ƒæ­¥æ•° |
| `--num_envs` | 8 | å¹¶è¡Œç¯å¢ƒæ•°é‡ |
| `--n_steps` | 2048 | æ¯æ¬¡rolloutæ­¥æ•° |
| `--batch_size` | 64 | Mini-batchå¤§å° |
| `--n_epochs` | 10 | PPOæ›´æ–°epochæ•° |
| `--lr` | 3e-4 | å­¦ä¹ ç‡ |
| `--gamma` | 0.99 | æŠ˜æ‰£å› å­ |
| `--gae_lambda` | 0.95 | GAE Î»å‚æ•° |
| `--clip_range` | 0.2 | PPO clipèŒƒå›´ |
| `--vf_coef` | 0.5 | ä»·å€¼å‡½æ•°æŸå¤±ç³»æ•° |
| `--ent_coef` | 0.01 | ç†µæŸå¤±ç³»æ•° |
| `--max_grad_norm` | 0.5 | æ¢¯åº¦è£å‰ªé˜ˆå€¼ |

## ğŸ“Š æ€§èƒ½é¢„æœŸ

### è®­ç»ƒé€Ÿåº¦
- **é‡‡æ ·é€Ÿåº¦**ï¼šçº¦4000-6000 FPSï¼ˆ8ä¸ªç¯å¢ƒï¼Œå–å†³äºCPUï¼‰
- **è®­ç»ƒæ—¶é—´**ï¼š200ä¸‡æ­¥çº¦éœ€è¦30-60åˆ†é’Ÿï¼ˆRTX 3060+ï¼‰
- **å†…å­˜å ç”¨**ï¼šçº¦2-3GB GPUæ˜¾å­˜

### è®­ç»ƒæ•ˆæœ
- **åˆæœŸæ¢ç´¢**ï¼ˆ0-50ä¸‡æ­¥ï¼‰ï¼šå¥–åŠ±é€æ¸ä»è´Ÿæ•°æå‡
- **å­¦ä¹ é˜¶æ®µ**ï¼ˆ50ä¸‡-150ä¸‡æ­¥ï¼‰ï¼šå¥–åŠ±å¿«é€Ÿä¸Šå‡ï¼Œå­¦ä¼šåŸºæœ¬é©¾é©¶
- **ä¼˜åŒ–é˜¶æ®µ**ï¼ˆ150ä¸‡+æ­¥ï¼‰ï¼šå¥–åŠ±è¶‹äºç¨³å®šï¼Œçº¦600-900åˆ†

## ğŸ“ è¾“å‡ºæ–‡ä»¶

è®­ç»ƒå®Œæˆåä¼šç”Ÿæˆï¼š

```
PPO/
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ ppo_checkpoint_YYYYMMDD_HHMMSS.pth  # å®šæœŸcheckpoint
â”‚   â””â”€â”€ ppo_final_YYYYMMDD_HHMMSS.pth       # æœ€ç»ˆæ¨¡å‹
â””â”€â”€ plots/
    â”œâ”€â”€ ppo_rewards_YYYYMMDD_HHMMSS.png     # å¥–åŠ±æ›²çº¿å›¾
    â””â”€â”€ ppo_reward_data_YYYYMMDD_HHMMSS.txt # å¥–åŠ±æ•°æ®
```

## ğŸ”§ ç½‘ç»œæ¶æ„

```
ActorCriticNetwork:
  Features (å…±äº«):
    Conv2d(4 â†’ 32, k=8, s=4) â†’ ReLU
    Conv2d(32 â†’ 64, k=4, s=2) â†’ ReLU
    Conv2d(64 â†’ 64, k=3, s=1) â†’ ReLU
    Flatten â†’ Linear(3136 â†’ 512) â†’ ReLU
  
  Actor (ç­–ç•¥ç½‘ç»œ):
    Linear(512 â†’ 3) â†’ Tanh
    å­¦ä¹ çš„log_stdå‚æ•°
  
  Critic (ä»·å€¼ç½‘ç»œ):
    Linear(512 â†’ 1)
```

## ğŸ› å¸¸è§é—®é¢˜

### 1. GPUå†…å­˜ä¸è¶³
- å‡å°‘ `--num_envs`ï¼ˆå¦‚æ”¹ä¸º4ï¼‰
- å‡å°‘ `--batch_size`ï¼ˆå¦‚æ”¹ä¸º32ï¼‰
- å‡å°‘ `--n_steps`ï¼ˆå¦‚æ”¹ä¸º1024ï¼‰

### 2. è®­ç»ƒä¸ç¨³å®š
- é™ä½å­¦ä¹ ç‡ `--lr 1e-4`
- å¢å¤§clipèŒƒå›´ `--clip_range 0.3`
- å‡å°ç†µç³»æ•° `--ent_coef 0.001`

### 3. æ”¶æ•›å¤ªæ…¢
- å¢åŠ ç¯å¢ƒæ•° `--num_envs 16`
- å¢å¤§å­¦ä¹ ç‡ `--lr 5e-4`
- å¢åŠ è®­ç»ƒæ­¥æ•° `--total_timesteps 5000000`

## ğŸ“š å‚è€ƒèµ„æ–™

- [Proximal Policy Optimization Algorithms](https://arxiv.org/abs/1707.06347)
- [Stable Baselines3 Documentation](https://stable-baselines3.readthedocs.io/)
- [Gymnasium CarRacing-v3](https://gymnasium.farama.org/environments/box2d/car_racing/)

## ğŸ“ å®ç°ç»†èŠ‚

### RolloutBuffer
- ä½¿ç”¨NumPyé¢„åˆ†é…æ•°ç»„ï¼Œé¿å…åŠ¨æ€åˆ—è¡¨å¼€é”€
- è‡ªåŠ¨è®¡ç®—GAEä¼˜åŠ¿å‡½æ•°å’Œreturns
- è‡ªåŠ¨æ ‡å‡†åŒ–advantagesï¼ˆæå‡è®­ç»ƒç¨³å®šæ€§ï¼‰

### æ··åˆç²¾åº¦è®­ç»ƒ
- ä½¿ç”¨PyTorch AMPè‡ªåŠ¨æ··åˆç²¾åº¦
- è‡ªåŠ¨å¤„ç†æ¢¯åº¦ç¼©æ”¾ï¼Œé˜²æ­¢underflow
- åœ¨æ”¯æŒTensor Coresçš„GPUä¸Šè·å¾—æœ€å¤§åŠ é€Ÿ

### å‘é‡åŒ–ç¯å¢ƒ
- AsyncVectorEnvä½¿ç”¨å¤šè¿›ç¨‹å¹¶è¡Œ
- è‡ªåŠ¨æ”¶é›†episodeç»Ÿè®¡ä¿¡æ¯
- æ”¯æŒå¼‚æ­¥stepï¼Œæœ€å¤§åŒ–ååé‡

## ğŸ® æµ‹è¯•

è®­ç»ƒå®Œæˆåä¼šè‡ªåŠ¨è¿è¡Œ3ä¸ªæµ‹è¯•episodeï¼ˆå¦‚æœæ”¯æŒrenderï¼‰ã€‚ä¹Ÿå¯ä»¥æ‰‹åŠ¨åŠ è½½æ¨¡å‹æµ‹è¯•ï¼š

```python
import torch
from agent import ActorCriticNetwork, PPOAgent

# åŠ è½½æ¨¡å‹
device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
agent = PPOAgent(action_dim=3, device=device)
agent.network.load_state_dict(torch.load("models/ppo_final_xxx.pth"))

# æµ‹è¯•...
```

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

| é…ç½® | é‡‡æ ·FPS | è®­ç»ƒæ—¶é—´(200ä¸‡æ­¥) | æœ€ç»ˆå¥–åŠ± |
|------|---------|-------------------|----------|
| å•ç¯å¢ƒ | ~800 | 4-5å°æ—¶ | 600-800 |
| 4å¹¶è¡Œç¯å¢ƒ | ~2500 | 1.5-2å°æ—¶ | 700-850 |
| 8å¹¶è¡Œç¯å¢ƒ | ~4500 | 45-60åˆ†é’Ÿ | 700-900 |
| 8ç¯å¢ƒ+AMP | ~6000 | 30-45åˆ†é’Ÿ | 700-900 |

*æµ‹è¯•é…ç½®ï¼šIntel i7-12700K + RTX 3060*

